---
title: "Téléchargement de données"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Téléchargement de données}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r rmd, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  out.width = "100%",
  dpi = 300,
  fig.width = 7.2916667,
  comment = "#>"
)
```

```{r setup, include = FALSE}
library(Rsequoia2)
library(sf)
library(tmap)
tmap_options(scale = 0.75)
```

# Introduction

## De quoi on parle ?

`Rsequoia2` offre la possibilité de télécharger un ensemble de données jugées pertinentes dans le cadre d'une gestion forestière durable et multifonctionnelle.

Il peut s'agir aussi bien de **couches vectorielles** que de **couches raster**.

Les fonctions se déclinent en fonctions autonomes `get_*` (où `*` correspont au thême de la couche) ou en fonctions intégrées au processus formalisé de *Sequoia* `seq_*`.

## Procesus Sequoia

Si l'utilisateur opte (et nous vous le conseillons) pour le procesus *Sequoia*, `Rsequoia2` télécharge et stocke les couches directement sur l'ordinateur.

Pour clarifier l'objet et la nature de ces données et afin d'en faciliter l'usage ultérieure, les couches téléchargées sont stockées selon leur thématiques:

-   **CADASTRE**: il s'agit des couches directement tirées des bases parcellaires (*PCI Etalab* ou *BD Parcelaire*).

-   **ENVIRONNEMENT**: y sont stockés les couches ayant trait aux zonages environnementaux tels que décrit par l'INPN.

-   **IFN**: il s'agit simplement des régions telles que décrites par l'IFN (ex: région forestières, sylvoécorégions, etc. )

-   **PATRIMOINE**: il s'agit des couches ayant trait aux zonages patrimoniaux (ex: monuments historiques)

-   **SOL**: cette rubrique regroupe les couches portant sur le sols (ex: carte géologique, carte pédologique, etc.).

-   **URBANISME**: les données tirées du géoportail de l'urbanisme y figurent (ex: prescriptions, SUP, etc.)

-   **VECTORIEL**: il s'agit des couches tirés de la *BD TOPO* servant notamment à l'habillage des cartes.

## Zone d'étude utilisée

La forêt étudiée dans l'article sera la forêt de Brin, propriété de l'école forestière de Nancy, située à Brin-Sur-Seille, dans le département de Meurthe-Et-Moselle (54).

```{r foret, fig.height = 3.5}
idu <- c(
  "540120000C0001", "540120000C0005", "540120000C0007", "540120000C0008",
  "540120000C0009", "540120000C0010", "540120000C0011", "540120000C0012",
  "540120000C0016", "540120000C0018", "540120000C0069", "540120000C0071",
  "540120000C0073", "540120000C0077", "540700000C0002", "540700000C0003",
  "540700000C0004", "540700000C0005", "540700000C0006", "540700000C0007",
  "540700000C0008", "540700000C0009", "540700000C0010", "540700000C0011",
  "540700000C0012", "540700000C0013", "540700000C0108", "540700000C0109",
  "540700000C0110", "540700000C0111", "540700000C0112", "540700000C0113",
  "540700000C0114", "540700000C0115", "540700000C0116", "540700000C0117",
  "540700000C0118", "540700000C0119", "540700000C0120", "540700000C0121",
  "54070000ZB0060", "540890000C0927", "540890000C0928", "540890000C1031",
  "541000000A0001", "541000000A0002", "541000000A0003", "541000000A0004",
  "541000000A0005", "541000000A0006", "541000000A0007", "541000000A0008",
  "541000000A0009", "541000000A0010", "541000000A0011", "541000000A0012",
  "541000000A0013", "541000000A0014", "541000000A0015", "541000000A0016",
  "541000000A0018", "541000000A0019", "541000000A0029", "541000000A0030",
  "541000000A0031", "541000000A0032", "541000000A0033", "541000000A0034",
  "541000000A0035", "541000000A0036", "541000000A0037", "541000000A0038",
  "541000000A0039", "541000000A0040", "541000000A0041", "541000000A0042",
  "541000000A0043", "541000000A0044", "541000000A0045", "541000000A0046",
  "541000000A0055", "541000000A0056", "541000000A0057", "541000000A0058",
  "541000000A0059", "541000000A0060", "541000000A0061", "541000000A0062",
  "541000000A0063", "541000000A0064", "541000000A0066", "541000000A0067",
  "541000000A0076", "541000000A0080", "541000000A0081", "541000000A0083",
  "541000000A0085", "541000000A0086", "541000000A0092", "541000000A0093",
  "541000000A0094", "541000000A0095", "541000000A0098", "541000000A0099",
  "541000000A0148", "541000000A0149", "541000000A0150", "541000000A0151",
  "541000000A0152", "541000000A0153", "541000000A0156", "541000000A0157",
  "54100000ZH0004", "54100000ZI0011"
)

parca <- get_parca(idu) |> transform(IDENTIFIANT = "BRIN")

foret <- Rsequoia2:::dissolve(parca, 5.5)

tm_shape(parca)+
  tm_borders(col = "blue", lwd = 2)+
tm_shape(foret)+
  tm_borders(col = "black", lwd = 2)
```

# 1. ACCESSIBILITE


# 2. CADASTRE

Cette partie sera rédigée quand Mucau daignera finaliser frcadastre.

# 3. ENVIRONNEMENT

```{r mnhm, include=FALSE}
mnhn_keys <- get_keys("mnhn")
```

La fonction `get_mnhn()` permet de télécharger un zonnage environnemtal en s'articulant autour de trois arguments :

-   `x` correspond au `sf` de la zone d'étude ;

-   `key` corespond à la clé (= type) du zonage recherché (ex: `"zps"`). Les clés disponibles sont : `r mnhn_keys` ;

-   `buffer` correspond au tempon éxécuté autour de la zone d'étude pour capter un résultat.

La fonction fait appelle en interne au package [`happign`](%22https://github.com/paul-carteron/happign%22).

**Exemple d'application:**

Typiquement, pour connaitre la présence d'une znieff, un `buffer = 0` avec `key = znieff2` permettra d'intersecter de protection. Pour obtenir l'immeuble inscrit ou classé, il convient d'utiliser `buffer = 500` avec `key = immh`.

```{r mnhm_fig, fig.height = 3.5}

znieff1 <- get_mnhn(x = parca, key = "znieff1", buffer = 500)
znieff2 <- get_mnhn(x = parca, key = "znieff2", buffer = 500)

tm_shape(foret) +
  tm_borders(col = "black", lwd = 2) +
tm_shape(znieff2) +
  tm_polygons(col = "green", fill_alpha = 0.4) +
tm_shape(znieff1) +
  tm_polygons(col = "red", fill_alpha = 0.4)
	
```

Si l'utilisateur opte pour le procesus *Sequoia*, la fonction `seq_mnhm()` travaille directement avec le dossier normalisé en récupérant la couche *PARCA* comme zone d'étude. Elle peut télécharger l'ensemble des zonages intersectés en utilisant `get_mnhm()` en boucle avec `key = get_keys("mnhn")` (toutes les couches). Chaque couche intersectée est alors enregistrée individuellement dans le dossier.

# 4. IFN

```{r ifn, include=FALSE}
ifn_keys <- get_keys("ifn")
```

La fonction `get_ifn()` permet de télécharger les régions définis par l'[inventaire forestier national](%22https://inventaire-forestier.ign.fr/spip.php?rubrique267%22) en s'articulant autour de deux arguments :

-   `x` correspond au `sf` de la zone d'étude ;

-   `key` corespond à la clé (= type) du zonage recherché (ex: `"ser"`). Les clés disponibles sont : `r ifn_keys`.

**Exemple d'application:**

Typiquement, pour connaitre la sylvoécorégion de notre forêt, il suffit d'utiliser `key = ser`. Cette information est indispensable pour connaitre les [matériels forestiers de reproduction](https://agriculture.gouv.fr/materiels-forestiers-de-reproduction-arretes-regionaux-relatifs-aux-aides-de-letat-linvestissement) à utiliser localement.

De même, pour connaitre la région forestière nationale, il suffit d'utiliser `key = rfn`. Cela permet de se localiser sur [Climessences](https://climessences.fr/) par exemple.

------------------------------------------------------------------------

La fonction `get_ser_pdf()` permet de télécharger les fiches descriptives des sylvoécorégions (exemple: la [SER C20](https://inventaire-forestier.ign.fr/IMG/pdf/C_20.pdf)).

Elle requiert les identifiants des SER en argument `id_ser` ainsi qu'un `dirname` (le chemin du dossier) où télécharger les fiches `.pdf`.

**Exemple d'application:**

Ces fiches sont pratiques pour enrichir la rédaction des documents de gestion (ou simplement se documenter sur une région).

# 5. PATRIMOINE

```{r pat, include=FALSE}
pat_keys <- get_keys("pat")
```

La fonction `get_patrimony()` permet d'obtenir les couches de l'[Atlas du patrimoine](%22http://atlas.patrimoines.culture.fr/atlas/trunk/static/presentation.html%22) en s'articulant autour de trois arguments :

-   `x` correspond au `sf` de la zone d'étude ;

-   `key` corespond à la clé (= type) du zonage recherché (ex: `"immh"`). Les clés disponibles sont : `r pat_keys` ;

-   `buffer` correspond au tempon éxécuté autour de la zone d'étude pour capter un résultat.

La fonction fait appelle en interne au package [`frheritage`](%22https://github.com/mucau/frheritage%22).

**Exemple d'application:**

Typiquement, pour connaitre la présence d'un monument historique, un `buffer = 0` avec `key = pamh` permettra d'intersecter le périmètre de protection. Pour obtenir l'immeuble inscrit ou classé, il convient d'utiliser `buffer = 500` avec `key = immh`.

```{r pat_fig, fig.height = 3.5}


```

La fonction `seq_patrimony()` récupère la couche *PARCA* du dossier normalisé et l'utilise comme zone d'étude.

Elle peut télécharger l'ensemble des zonages intersectés en utilisant `get_patrimony()` en boucle avec `key = get_keys("pat")` (toutes les couches). Chaque couche intersectée est alors enregistrée individuellement dans le dossier.

# 6. SOL

## 6.1 Les bases géologiques départementales du BRGM

La fonction `get_brgm()` permet de télécharger depuis le BRGM :

-   la [cartes géologiques départementales à 1/50 000 (Bd Charm-50)](https://infoterre.brgm.fr/formulaire/telechargement-cartes-geologiques-departementales-150-000-bd-charm-50)

-   les [données géologiques dédiées au programme de Cartographie des Habitats Naturels et semi-naturels (CARHAB)](https://infoterre.brgm.fr/formulaire/telechargement-donnees-geologiques-dediees-au-programme-cartographie-habitats-naturels).

La fonction s'articule essentiellement autour de deux arguments :

-   `deps` correspond au département(s) ciblés par la requête ;

-   `source` corespond à la clé (= type) de la couche (`"bdcharm50"`, `"carhab"`) ;

Cette fonction a essentiellement pour objet de télécharger les bases départementales.

## 6.2 Géologie

La fonction `get_geol()` permet de récupérer les jeux de données précédents sur une zone d'étude.

La fonction ajoute un argument `x` correspondant au `sf` de la zone d'étude.

**Exemple d'application:**

La géologie est indispensable pour établir des cartes géologiques des forêts.

## 6.3 Pédologie

La fonction `get_pedology()` permet de récupérer la [carte des sols](https://www.gissol.fr/donnees/carte-sur-le-geoportail-4789).

Elle n'a besoin que d'un `sf` de la zone d'étude en argument `x`.

**Exemple d'application:**

La pédologie permet d'enrichir la rédaction des documents de gestion.

------------------------------------------------------------------------

La fonction `get_pedology_pdf` permet de récupérer les fiches détaillées des ucs (exemple: [UCS 5513](https://data.geopf.fr/annexes/ressources/INRA_carte_des_sols/INRA/id_ucs_5513.pdf)). Elle requiert les identifiants des UCS en argument `id_ucs` ainsi qu'un `dirname` (le chemin du dossier) où télécharger les fiches `.pdf`.

# 7. URBANISME

```{r gpu, include=FALSE}
gpu_keys <- get_keys("gpu", reduce = FALSE)
```

La fonction `get_gpu()` permet de télécharger depuis le GPU:

-   Les municipalités détectées ;

-   Les documents d'urbanismes ;

-   Les zones du documents d'urbanisme (exemple: "N" pour les zones naturelles) ;

-   Les prescriptions ponctuelles, linéaires et surfacique ;

-   Les assiettes (emprises surfaciques) des servitudes d'utilité publiques (SUP) ;

-   Les generateurs (object ponctuel, linéaire ou surfacique générant les assiettes) des servitudes d'utilité publiques (SUP).

Comme précédement, la fonction s'articule autour des arguments:
-   `x` correspond au `sf` de la zone d'étude ;

-   `key` corespond à la clé (= type) du zonage recherché (ex: `"v.gpu.document.poly"`). Les clés disponibles sont un peu plus complexes : `r gpu_keys`.

```{r gpu_fig, fig.height = 3.5}


```

**Exemple d'application:**

L'ubanisme est régulièrement mis de côté lors de la rédaction des documents de gestion. Pourant, le forestier est soumis comme chacun aux règlements d'ubanisme. Indiquer les prescriptions et SUP est donc primordial.

**Attention:**
Les rédacteurs des documents d'urbanismes restent des hommes. Des erreurs, incohérences ou ommissions ont été relevées dans les jeux de données testés. La prudence et la vérification des informations est donc préférable.

----

La fonction `seq_patrimony()` récupère la couche *PARCA* du dossier normalisé et l'utilise comme zone d'étude.

Elle peut télécharger l'ensemble des zonages intersectés en utilisant `get_patrimony()` en boucle avec `key = get_keys("pat")` (toutes les couches). Chaque couche intersectée est alors enregistrée individuellement dans le dossier.

# 8. SECURITE

# 9. VECTORIEL

## 9.1 Communes

## 9.2 Toponymes

## 9.3 Infrastructures (hors desserte)

## 9.4 Desserte

## 9.2 Hydrologie

## 9.6 Végétation
