---
title: "Parcelles cadastrales - Personne morale (FR)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Parcelles cadastrales - Personne morale (FR)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  out.width = "100%",
  dpi = 300,
  fig.width = 7.2916667,
  comment = "#>"
)
```

```{r, echo = FALSE, message = FALSE}
library(tmap)
tmap_options(scale = 0.75)
```

```{r package}
library(Rsequoia2)
library(tmap)
library(openxlsx2)
library(sf)
```

Comme pour chaque processus Sequoia, la première étape consiste à créer un répertoire de travail (ici temporaire).

```{r setup_seqdir}
seq_dir <- file.path(tempdir(), "MY_FOREST")
dir.create(seq_dir)
```

# Qu'est-ce qu'une personne morale

En France, une personne morale, contrairement à une personne physique, à sa propre existence juridique. Elle est identifié par un code SIRET ou SIREN. En forêt, on retouve classiquement les groupements forestiers.

La **Direction Générale des Finances Publiques** (DGFiP) met à disposition un fichier contenant toutes les parcelles cadastrales dont le propriétaire est une personne morale.

`Rsequoia2` facilite l'accès à ce jeux de données et la recherche de personne morale.

## Trouver une personne morale

La fonction `get_legal_entity()` télécharge et formate les données cadastrales pour s'intégrer dans un processus Sequoia.. 

Les données peuvent être chargées à partir d'un code département ou d'un code INSEE.

Le chargement par département peut être plus long, mais il permet d'identifier automatiquement les parcelles d'un propriétaire situées dans plusieurs communes du département.

```{r get_legal_entity}
# cp: cadastrals parcels
insee <- c("29158", "29165")

legal_entity_cp <- get_legal_entity(insee)

head(legal_entity_cp)
```

## Rechercher un propriétaire

Une fois le fichier chargé, vous pouvez utiliser la fonction utilitaire `search_legal_entity()`.

Cette fonction applique une normalisation ce qui rend la recherche robuste aux différences d'accents, de ponctuation, d'espacement et de casse., par exemple :

- "État / Forêts" -> "ETATFORETS"
- " Le Bois-de l'Orme " -> "LEBOISDELORME"
- "Société du Chêne" -> "SOCIETEDUCHENE"

L'exemple ci-dessous permet d'identifier tous les GFA (« Groupements Fonciers Agricoles »).

```{r search_legal_entity}
search_mat <- search_legal_entity(legal_entity_cp, prop = "gfa")

unique(search_mat$PROPRIETAIRE)
```

`search_legal_entity()` support plusieurs propriétaires:

```{r search_legal_entity_multiple}
search_mat <- search_legal_entity(legal_entity_cp, prop = c("conservatoire", "espace", "naturel"))

unique(search_mat$PROPRIETAIRE)
```

Egalement, la recherche de parcelles peut se faire à partir des lieux-dits.

```{r search_legal_entity_lieu_dit}
search_mat <- search_legal_entity(legal_entity_cp, lieu_dit = "phare")

unique(search_mat[,c("PROPRIETAIRE", "LIEU_DIT")])
```

## Enregistrer la matrice pour démarrer un processus Sequoia

Le jeu de données des personnes morales ne contient pas de géométrie. Il sert à générer une matrice Excel (`*_matrice.xlsx`) nécessaire au démarrage d'un processus Sequoia. La fonction `seq_write()` permet de créer ce fichier.

Le `data.frame` retourné par `get_legal_entity()` est déjà formaté pour Sequoia, incluant la colonne `"IDENTIFIANT"`.

Il est recommandé de renseigner cette colonne directement dans R avant d'enregistrer la matrice, afin d'éviter toute modification manuelle dans Excel.

```{r save_legal_entity}
id <- "MY_FOREST"
search_mat$IDENTIFIANT <- id

seq_write(
  x = search_mat,
  key = "matrice",
  dirname = seq_dir,
  id = id
)

seq_parca(seq_dir)
parca <- seq_read("parca", seq_dir)

tm_tiles("OpenStreetMap")+
tm_shape(parca)+
  tm_borders(col = "firebrick", lwd = 2)
```
